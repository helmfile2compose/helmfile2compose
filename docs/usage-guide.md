# Usage Guide

This guide covers day-to-day operations once your compose setup is running. For project-specific setup (prerequisites, quick start, DNS), see your project's own deployment doc.

## The golden rule

**Do not edit `compose.yml` or `Caddyfile` by hand.** They are generated from the Helm charts and will be overwritten on the next run of `generate-compose.sh`.

All configuration lives in two files:

| File | Controls |
|------|----------|
| `environments/compose.yaml` | Domain, enabled services, secrets, app-specific config |
| `helmfile2compose.yaml` | Volume paths, excludes, service overrides, custom services |

Edit those, then re-run:

```bash
./generate-compose.sh
docker compose up -d
```

## Regenerating

After changing helmfile values, chart versions, or helmfile2compose config:

```bash
./generate-compose.sh
docker compose up -d
```

The script re-renders helmfile templates and regenerates compose. Existing `environments/compose.yaml` and `helmfile2compose.yaml` are preserved — only `compose.yml`, `Caddyfile`, `configmaps/`, and `secrets/` are overwritten.

**Pull regularly.** The compose deployment piggybacks on the same Helm charts used for Kubernetes. When charts are updated (version bumps, config fixes, new features), `git pull && ./generate-compose.sh` picks them up — no manual compose.yml editing.

## Data management

All persistent data lives under the configured data directory (`volume_root` in `helmfile2compose.yaml`).

To reset everything (fresh databases):

```bash
docker compose down
rm -rf ./data    # or your configured volume_root
docker compose up -d
```

**Warning**: Database init scripts (database/user creation) only run on first boot. Adding a new service that needs its own database may require a data reset.

## compose.override.yml

Docker and nerdctl automatically load `compose.override.yml` alongside `compose.yml` — no `-f` flag needed.

Use it for local workarounds that shouldn't be in the generated compose:

```yaml
services:
  my-backend:
    image: my-backend:fixed   # local rebuild for ARM64
```

This file is not generated by helmfile2compose — create it manually if needed.

## Troubleshooting

### Self-signed certificate warnings

For `.local` domains, Caddy uses its internal CA. Browsers show a certificate warning — click through it. To suppress warnings permanently, trust Caddy's root CA certificate.

### Database not ready

Init jobs (migrations, superuser creation) use `restart: on-failure` and retry until the database is ready. Check progress:

```bash
docker compose logs -f <service>-migrate
```

### configmaps/ or secrets/ missing

If you ran `docker compose up` without first running `generate-compose.sh`, the container runtime creates empty directories instead of the expected files. Fix:

```bash
docker compose down
rm -rf configmaps/ secrets/
./generate-compose.sh
docker compose up -d
```

### LiveKit ICE failures

If calls connect but media doesn't flow, check that UDP ports are mapped:

```bash
docker compose ps livekit-livekit-server
# Should show: 0.0.0.0:50000-50100->50000-50100/udp, 0.0.0.0:7881->7881/tcp
```

See [architecture.md](architecture.md#dockercompose-vs-kubernetes-gotchas) for the port range sizing rationale.

### Re-generating from scratch

Delete the generated files and start over:

```bash
docker compose down -v
rm -f compose.yml Caddyfile
rm -rf configmaps/ secrets/ generated-platform/
# Optionally reset environment + config:
# rm -f environments/compose.yaml helmfile2compose.yaml
./generate-compose.sh
docker compose up -d
```
